<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
  xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.6.xsd">

  <changeSet id="v1.3.1" author="p.luhin">
    <comment>Add table credentials and users</comment>
    <createTable tableName="credentials">
      <column name="id" autoIncrement="true" type="INT">
        <constraints unique="true" primaryKey="true" nullable="false"/>
      </column>
      <column name="username" type="VARCHAR(100)">
        <constraints nullable="false" unique="true"/>
      </column>
      <column name="sender" type="VARCHAR(20)">
        <constraints nullable="false" unique="true"/>
      </column>
      <column name="api_key" type="VARCHAR(50)">
        <constraints nullable="false" unique="true"/>
      </column>
      <column name="created_by" type="VARCHAR(100)">
        <constraints nullable="false"/>
      </column>
      <column name="created_date" type="DATETIME">
        <constraints nullable="false"/>
      </column>
    </createTable>

    <createTable tableName="users">
      <column name="id" autoIncrement="true" type="int">
        <constraints unique="true" nullable="false" primaryKey="true"/>
      </column>
      <column name="username" type="VARCHAR(100)">
        <constraints nullable="false" unique="true"/>
      </column>
      <column name="password" type="VARCHAR(32)">
        <constraints nullable="false"/>
      </column>
      <column name="default_credentials" type="INT"/>
      <column name="created_by" type="VARCHAR(100)">
        <constraints nullable="false"/>
      </column>
      <column name="created_date" type="DATETIME">
        <constraints nullable="false"/>
      </column>
    </createTable>
    <addForeignKeyConstraint baseTableName="users" baseColumnNames="default_credentials"
      constraintName="def_creds_key"
      referencedTableName="credentials" referencedColumnNames="id" onDelete="SET NULL"/>

    <insert tableName="users">
      <column name="username" type="VARCHAR(100)">pavel.luhin@gmail.com</column>
      <column name="password" type="VARCHAR(32)">42d8aa7cde9c78c4757862d84620c335</column>
      <column name="created_by" type="VARCHAR(100)">SYSTEM</column>
      <column name="created_date" type="DATETIME" valueComputed="NOW()"/>
    </insert>

    <createTable tableName="users_credentials">
      <column name="user_id" type="INT">
        <constraints nullable="false"/>
      </column>
      <column name="credentials_id" type="INT">
        <constraints nullable="false"/>
      </column>
    </createTable>
    <addForeignKeyConstraint baseTableName="users_credentials" baseColumnNames="user_id"
      constraintName="user_user_fk"
      referencedTableName="user" referencedColumnNames="id" onDelete="CASCADE"/>
    <addForeignKeyConstraint baseTableName="users_credentials" baseColumnNames="credentials_id"
      constraintName="user_cred_fk"
      referencedTableName="credentials" referencedColumnNames="id" onDelete="CASCADE"/>
  </changeSet>

  <changeSet id="v1.3.2" author="p.luhin">
    <comment>Add token and sms template</comment>
    <createTable tableName="authentication_token">
      <column name="id" autoIncrement="true" type="INT">
        <constraints primaryKey="true" nullable="false" unique="true"/>
      </column>
      <column name="expires" type="DATETIME">
        <constraints nullable="false"/>
      </column>
      <column name="token" type="VARCHAR(36)">
        <constraints nullable="false" unique="true"/>
      </column>
      <column name="user_id" type="INT">
        <constraints nullable="false"/>
      </column>
    </createTable>
    <addForeignKeyConstraint baseTableName="authentication_token" baseColumnNames="user_id"
      constraintName="token_user_fk"
      referencedTableName="user" referencedColumnNames="id" onDelete="CASCADE"/>

    <createTable tableName="sms_template">
      <column name="id" autoIncrement="true" type="INT">
        <constraints primaryKey="true" nullable="false" unique="true"/>
      </column>
      <column name="sms_type" type="VARCHAR(50)">
        <constraints nullable="false" unique="true"/>
      </column>
      <column name="template" type="LONGTEXT">
        <constraints nullable="false"/>
      </column>
      <column name="enabled" type="BOOLEAN" defaultValueBoolean="true">
        <constraints nullable="false"/>
      </column>
      <column name="created_by" type="VARCHAR(100)">
        <constraints nullable="false"/>
      </column>
      <column name="created_date" type="DATETIME">
        <constraints nullable="false"/>
      </column>
    </createTable>

    <insert tableName="sms_template">
      <column name="sms_type" type="VARCHAR(50)">RegisterUserSMS</column>
      <column name="template" type="LONGTEXY">
        Your account have been registered on SMS server with username ${EMAIL}
        and password ${PASSWORD}. Server URL is ${SERVER.URL}
      </column>
      <column name="enabled" type="BOOLEAN" valueBoolean="false"/>
      <column name="created_by" type="VARCHAR(100)">SYSTEM</column>
      <column name="created_date" type="DATETIME" valueComputed="NOW()"/>
    </insert>
  </changeSet>

  <changeSet id="v1.3.3" author="p.luhin">
    <comment>Add email template</comment>
    <createTable tableName="email_template">
      <column name="id" autoIncrement="true" type="INT">
        <constraints nullable="false" unique="true" primaryKey="true"/>
      </column>
      <column name="content" type="LONGTEXT">
        <constraints nullable="false"/>
      </column>
      <column name="subject" type="VARCHAR(100)">
        <constraints nullable="false"/>
      </column>
      <column name="sms_type" type="INT">
        <constraints nullable="false"/>
      </column>
      <column name="created_by" type="VARCHAR(100)">
        <constraints nullable="false"/>
      </column>
      <column name="created_date" type="DATETIME">
        <constraints nullable="false"/>
      </column>
    </createTable>
    <addForeignKeyConstraint baseTableName="email_template" baseColumnNames="sms_type"
      constraintName="template_fk"
      referencedTableName="sms_template" referencedColumnNames="id" onDelete="CASCADE"/>

    <insert tableName="email_template">
      <column name="sms_type" type="INT"
        valueComputed="(SELECT id FROM sms_template WHERE sms_type='RegisterUserSMS')"/>
      <column name="subject" type="VARCHAR(100)">Your account on SMS-Server was registered</column>
      <column name="content" type="LONGTEXT"><![CDATA[
        Hello ${USERNAME},
        <br>
        <br>Your account on SMS-Server was successfully registered.
        <br>
        SMS-Server address is: ${SERVER.URL}
        <br>
        Use the following credentials to log in:
        <br>
        <b>Username:</b>
        ${EMAIL}
        <br>
        <b>Password</b>: ${PASSWORD}
        ]]>
      </column>
      <column name="created_by" type="VARCHAR(100)">SYSTEM</column>
      <column name="created_date" type="DATETIME" valueComputed="NOW()"/>
    </insert>
  </changeSet>

  <changeSet id="v1.3.4" author="p.luhin">
    <comment>Add external applications</comment>
    <createTable tableName="external_application">
      <column name="id" autoIncrement="true" type="INT">
        <constraints unique="true" nullable="false" primaryKey="true"/>
      </column>
      <column name="application_name" type="VARCHAR(50)">
        <constraints nullable="false" unique="true"/>
      </column>
      <column name="authentication" type="VARCHAR(36)">
        <constraints nullable="false" unique="true"/>
      </column>
      <column name="default_credentials" type="INT">
        <constraints nullable="false"/>
      </column>
      <column name="created_by" type="VARCHAR(100)">
        <constraints nullable="false"/>
      </column>
      <column name="created_date" type="DATETIME">
        <constraints nullable="false"/>
      </column>
    </createTable>
    <addForeignKeyConstraint baseTableName="external_application"
      baseColumnNames="default_credentials" constraintName="app_default_creds"
      referencedTableName="credentials" referencedColumnNames="id" onDelete="NO ACTION"/>
  </changeSet>

  <changeSet id="v1.3.5" author="p.luhin">
    <comment>Add recipients</comment>

    <createTable tableName="person">
      <column name="id" autoIncrement="true" type="INT">
        <constraints nullable="false" unique="true" primaryKey="true"/>
      </column>
      <column name="email" type="VARCHAR(100)">
        <constraints nullable="false"/>
      </column>
      <column name="first_name" type="VARCHAR(50)">
        <constraints nullable="false"/>
      </column>
      <column name="last_name" type="VARCHAR(50)">
        <constraints nullable="false"/>
      </column>
      <column name="phone_number" type="VARCHAR(10)">
        <constraints nullable="false"/>
      </column>
      <column name="temporary" type="BOOLEAN" defaultValueBoolean="false">
        <constraints nullable="false"/>
      </column>
      <column name="created_by" type="VARCHAR(100)">
        <constraints nullable="false"/>
      </column>
      <column name="created_date" type="DATETIME">
        <constraints nullable="false"/>
      </column>
    </createTable>

    <createTable tableName="recipient_group">
      <column name="id" autoIncrement="true" type="INT">
        <constraints nullable="false" unique="true" primaryKey="true"/>
      </column>
      <column name="name" type="VARCHAR(50)">
        <constraints nullable="false" unique="true"/>
      </column>
      <column name="temporary" type="BOOLEAN" defaultValueBoolean="true">
        <constraints nullable="false"/>
      </column>
      <column name="created_by" type="VARCHAR(100)">
        <constraints nullable="false"/>
      </column>
      <column name="created_date" type="DATETIME">
        <constraints nullable="false"/>
      </column>
    </createTable>

    <createTable tableName="persons_have_groups">
      <column name="person_id" type="INT"/>
      <column name="group_id" type="INT"/>
    </createTable>
    <addForeignKeyConstraint baseTableName="persons_have_groups" baseColumnNames="person_id"
      constraintName="person_fk"
      referencedTableName="person" referencedColumnNames="id" onDelete="CASCADE"/>
    <addForeignKeyConstraint baseTableName="persons_have_groups" baseColumnNames="group_id"
      constraintName="group_fk"
      referencedTableName="recipient_group" referencedColumnNames="id" onDelete="CASCADE"/>
  </changeSet>

  <changeSet id="v1.3.6" author="p.luhin">
    <comment>Add statistics</comment>
    <createTable tableName="statistics">
      <column name="id" autoIncrement="true" type="INT">
        <constraints primaryKey="true" unique="true" nullable="false"/>
      </column>
      <column name="error" type="BOOLEAN">
        <constraints nullable="false"/>
      </column>
      <column name="recipient" type="VARCHAR(101)">
        <constraints nullable="false"/>
      </column>
      <column name="recipient_type" type="ENUM('PERSON', 'GROUP', 'NUMBER')">
        <constraints nullable="false"/>
      </column>
      <column name="response" type="LONGTEXT">
        <constraints nullable="false"/>
      </column>
      <column name="sender" type="VARCHAR(20)">
        <constraints nullable="false"/>
      </column>
      <column name="sent_date" type="DATETIME">
        <constraints nullable="false"/>
      </column>
      <column name="sms_type" type="VARCHAR(50)">
        <constraints nullable="false"/>
      </column>
      <column name="text" type="LONGTEXT">
        <constraints nullable="false"/>
      </column>
      <column name="initiated_by" type="VARCHAR(100)" defaultValue="pavel.luhin@gmail.com">
        <constraints nullable="false"/>
      </column>
    </createTable>
  </changeSet>

  <changeSet id="v1.3.7" author="p.luhin">
    <comment>Add properties</comment>
    <createTable tableName="sms_server_property">
      <column name="property_key" type="VARCHAR(30)">
        <constraints nullable="false" unique="true" primaryKey="true"/>
      </column>
      <column name="value" type="VARCHAR(100)"/>
      <column name="property_group" type="VARCHAR(30)" defaultValue="UNASSIGNED">
        <constraints nullable="false"/>
      </column>
    </createTable>

    <insert tableName="sms_server_property">
      <column name="property_key" type="VARCHAR(30)">MUTE_ENABLED</column>
      <column name="value" type="VARCHAR(100)">false</column>
      <column name="property_group" type="VARCHAR(30)">MUTE_MODE</column>
    </insert>
    <insert tableName="sms_server_property">
      <column name="property_key" type="VARCHAR(30)">MUTE_START_TIME</column>
      <column name="value" type="VARCHAR(100)">00:00</column>
      <column name="property_group" type="VARCHAR(30)">MUTE_MODE</column>
    </insert>
    <insert tableName="sms_server_property">
      <column name="property_key" type="VARCHAR(30)">MUTE_END_TIME</column>
      <column name="value" type="VARCHAR(100)">00:00</column>
      <column name="property_group" type="VARCHAR(30)">MUTE_MODE</column>
    </insert>

    <insert tableName="sms_server_property">
      <column name="property_key" type="VARCHAR(30)">EMAIL_ENABLED</column>
      <column name="value" type="VARCHAR(100)">false</column>
      <column name="property_group" type="VARCHAR(30)">EMAIL</column>
    </insert>
    <insert tableName="sms_server_property">
      <column name="property_key" type="VARCHAR(30)">USERNAME</column>
      <column name="property_group" type="VARCHAR(30)">EMAIL</column>
    </insert>
    <insert tableName="sms_server_property">
      <column name="property_key" type="VARCHAR(30)">PASSWORD</column>
      <column name="property_group" type="VARCHAR(30)">EMAIL</column>
    </insert>
    <insert tableName="sms_server_property">
      <column name="property_key" type="VARCHAR(30)">SMTP_HOST</column>
      <column name="property_group" type="VARCHAR(30)">EMAIL</column>
    </insert>
    <insert tableName="sms_server_property">
      <column name="property_key" type="VARCHAR(30)">SMTP_PORT</column>
      <column name="property_group" type="VARCHAR(30)">EMAIL</column>
    </insert>
    <insert tableName="sms_server_property">
      <column name="property_key" type="VARCHAR(30)">AUTHENTICATION_ENABLED</column>
      <column name="property_group" type="VARCHAR(30)">EMAIL</column>
    </insert>
    <insert tableName="sms_server_property">
      <column name="property_key" type="VARCHAR(30)">TLS_ENABLED</column>
      <column name="property_group" type="VARCHAR(30)">EMAIL</column>
    </insert>
  </changeSet>

  <changeSet id="v1.3.8" author="p.luhin">
    <comment>Add sms queue</comment>
    <createTable tableName="sms_queue">
      <column name="id" autoIncrement="true" type="INT">
        <constraints nullable="false" unique="true" primaryKey="true"/>
      </column>
      <column name="recipient" type="VARCHAR(101)">
        <constraints nullable="false"/>
      </column>
      <column name="recipient_type" type="ENUM('PERSON', 'GROUP', 'NUMBER')">
        <constraints nullable="false"/>
      </column>
      <column name="message" type="LONGTEXT">
        <constraints nullable="false"/>
      </column>
      <column name="credentials_id" type="INT">
        <constraints nullable="false"/>
      </column>
      <column name="duplicate_email" type="BOOLEAN" defaultValueBoolean="false">
        <constraints nullable="false"/>
      </column>
      <column name="initiated_by" type="VARCHAR(100)">
        <constraints nullable="false"/>
      </column>
      <column name="sms_type" type="VARCHAR(50)">
        <constraints nullable="false"/>
      </column>
      <column name="parameters_json" type="LONGTEXT"/>
    </createTable>
    <addForeignKeyConstraint baseTableName="sms_queue" baseColumnNames="credentials_id"
      constraintName="creds_fk"
      referencedTableName="credentials" referencedColumnNames="id" onDelete="NO ACTION"/>
  </changeSet>
</databaseChangeLog>